
# where to install the binary executable
PREFIX = @prefix@
BINDIR = $(PREFIX)/bin

# where to put the style file
BASETEXDIR = $(PREFIX)/share/texmf
TEXDIR = $(BASETEXDIR)/tex/latex/misc 

# command to update TeX' kpathsea database
MKTEXLSR = @MKTEXLSR@
UPDATETEX = $(MKTEXLSR) /usr/share/texmf /var/spool/texmf $(BASETEXDIR) > /dev/null

# Version
MAJORVN=0
MINORVN=8
VERSION=$(MAJORVN).$(MINORVN)

CAMLC    = @OCAMLC@
CAMLCOPT = @OCAMLOPT@
CAMLDEP  = @OCAMLDEP@

ZLIBS    = -I ocaml-parser
DEBUG    = 
PROFILE  =
BYTEFLAGS= $(ZLIBS) $(DEBUG)
OPTFLAGS = $(ZLIBS) $(PROFILE)

CAML_CMO = ocaml-parser/misc.cmo ocaml-parser/clflags.cmo	\
	   ocaml-parser/terminfo.cmo ocaml-parser/warnings.cmo	\
           ocaml-parser/linenum.cmo ocaml-parser/location.cmo	\
	   ocaml-parser/longident.cmo ocaml-parser/pstream.cmo	\
           ocaml-parser/syntaxerr.cmo ocaml-parser/parser.cmo	\
           ocaml-parser/lexer.cmo ocaml-parser/parse.cmo

CAML_CMX = $(CAML_CMO:.cmo=.cmx)

CMO = output.cmo cross.cmo pretty.cmo \
      web.cmo doclexer.cmo \
      version.cmo main.cmo

CMX = $(CMO:.cmo=.cmx)

all: @BEST@

opt: ocamlweb

byte: ocamlweb.byte

ocamlweb: $(CAML_CMX) $(CMX)
	$(CAMLCOPT) $(OPTFLAGS) -o ocamlweb $(CAML_CMX) $(CMX)
	strip ocamlweb

ocamlweb.byte: $(CAML_CMO) $(CMO)
	$(CAMLC) $(BYTEFLAGS) -o ocamlweb.byte $(CAML_CMO) $(CMO)

debug: $(CAML_CMO) $(CMO)
	$(CAMLC) $(BYTEFLAGS) -o ocamlweb-debug $(CAML_CMO) $(CMO)

version.ml: Makefile
	echo "let version = \""$(VERSION)"\"" > version.ml
	echo "let date = \""`date`"\"" >> version.ml

install:
	mkdir -p $(BINDIR)
	if test @BEST@ = opt ; then \
		cp ocamlweb $(BINDIR) ; \
	else \
		cp ocamlweb.byte $(BINDIR)/ocamlweb ; \
	fi
	mkdir -p $(TEXDIR)
	cp ocamlweb.sty $(TEXDIR)	
	$(UPDATETEX)

local:
	cp ocamlweb $$HOME/bin/$$OSTYPE

install-demons:
	cp ocamlweb /users/demons/demons/bin/$$OSTYPE
	cp ocamlweb.sty /users/demons/demons/tex/inputs

manual:
	cd doc; make all

LATEX=TEXINPUTS=..: ; export TEXINPUTS ; latex

test/test.tex: ocamlweb test/test.ml test/test.mli
	cd test; ../ocamlweb test.mli test.ml -o test.tex

test: test/test.tex
	cd test; \
	$(LATEX) test ; grep -q "Rerun" test.log && $(LATEX) test || true; \
	-hevea -o test.html ../ocamlweb.sty test.tex; \
	xdvi test.dvi

BOOTSTRAP= bootstrap.tex output.mli output.ml cross.mli cross.ml \
           pretty.mli pretty.mll \
	   web.mli web.ml doclexer.mli doclexer.mll main.ml 

bootstrap: ocamlweb
	./ocamlweb -o test/ocamlweb.tex $(BOOTSTRAP)
	cd test; $(LATEX) ocamlweb
	cd test; grep -q "Rerun" ocamlweb.log && $(LATEX) ocamlweb || true
	-cd test; hevea -o ocamlweb.html ../ocamlweb.sty ocamlweb.tex
	cd test; dvips ocamlweb.dvi -o ocamlweb.ps

check: bootstrap

# export
########

NAME=ocamlweb-$(VERSION)

FTP = /users/demons/filliatr/ftp/ocaml/ocamlweb

FILES = doclexer.mli doclexer.mll cross.ml cross.mli		\
	pretty.mli pretty.mll \
	output.mli output.ml web.mli web.ml main.ml	        \
	ocamlweb.sty bootstrap.tex				\
	Makefile.in configure .depend README INSTALL COPYING GPL CHANGES

OCAMLFILES = misc.mli misc.ml clflags.ml	\
        terminfo.mli terminfo.ml		\
	warnings.mli warnings.ml		\
	linenum.mli linenum.mll			\
	location.mli location.ml		\
	longident.mli longident.ml		\
	pstream.mli pstream.ml			\
	syntaxerr.mli syntaxerr.ml		\
	asttypes.mli parsetree.mli		\
	parser.mly				\
	lexer.mli lexer.mll			\
	parse.mli parse.ml			\
	README

DOCFILES = doc/ocamlweb-man.ps doc/ocamlweb-man.html

export: source linux
	cp README COPYING GPL CHANGES $(FTP)
	cd doc; make all export
	make export-bootstrap

export-bootstrap: bootstrap
	gzip -c test/ocamlweb.ps > $(FTP)/ocamlweb.ps.gz
	cp test/ocamlweb.html $(FTP)

source: manual
	mkdir -p export/$(NAME)/test
	cd export/$(NAME); mkdir -p ocaml-parser; mkdir -p test; \
	  mkdir -p doc; mkdir -p support
	cp $(FILES) export/$(NAME)
	cp $(DOCFILES) export/$(NAME)/doc
	cd ocaml-parser; cp $(OCAMLFILES) ../export/$(NAME)/ocaml-parser
	cd support; cp config.guess config.sub install-sh \
	  ../export/$(NAME)/support
	cd export ; tar cf $(NAME).tar $(NAME) ; \
	  gzip -f --best $(NAME).tar
	cp export/$(NAME).tar.gz $(FTP)

BINARY = $(NAME)-$(OSTYPE)

linux: clean binary

solaris:
	rmake sun-demons $(HOME)/soft/ocaml/ocamlweb clean binary

BINARYFILES = README INSTALL COPYING GPL ocamlweb ocamlweb.sty

binary: ocamlweb manual
	mkdir -p export/$(BINARY)/doc
	cp $(BINARYFILES) export/$(BINARY)
	cp $(DOCFILES) export/$(BINARY)/doc
	(cd export; tar czf $(BINARY).tar.gz $(BINARY))
	cp export/$(BINARY).tar.gz $(FTP)

# generic rules :
#################

.SUFFIXES: .mli .ml .cmi .cmo .cmx .mll

.mll.ml:
	ocamllex $<

.mli.cmi:
	$(CAMLC) -c $(BYTEFLAGS) $<

.ml.cmo:
	$(CAMLC) -c $(BYTEFLAGS) $<

.ml.o:
	$(CAMLCOPT) -c $(OPTFLAGS) $<

.ml.cmx:
	$(CAMLCOPT) -c $(OPTFLAGS) $<

ocaml-parser/parser.mli ocaml-parser/parser.ml: ocaml-parser/parser.mly
	ocamlyacc -v ocaml-parser/parser.mly


# clean and depend
##################

GENERATED = doclexer.ml pretty.ml version.ml \
            ocaml-parser/lexer.ml ocaml-parser/linenum.ml \
	    ocaml-parser/parser.mli ocaml-parser/parser.ml 

clean:
	rm -f *~ *.cm[iox] *.o 
	rm -f ocaml-parser/*~ ocaml-parser/*.cm[iox] ocaml-parser/*.o
	rm -f ocamlweb 
	rm -f $(GENERATED)
	rm -f ocaml-parser/parser.output
	make -C doc clean
	cd test; rm -f *.aux *.log *.dvi *.ps *.tex

depend: $(GENERATED)
	rm -f .depend
	ocamldep $(ZLIBS) *.mli *.ml ocaml-parser/*.ml ocaml-parser/*.mli > .depend

include .depend

